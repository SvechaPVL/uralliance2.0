---
description: Выявить недоопределенные области в текущей спецификации функции, задав до 5 высоко целевых уточняющих вопросов и закодировав ответы обратно в спецификацию.
---

## Пользовательский Ввод

```text
$ARGUMENTS
```

Вы **ДОЛЖНЫ** учитывать пользовательский ввод перед продолжением (если не пуст).

## Описание

Цель: Обнаружить и уменьшить неоднозначность или отсутствующие точки принятия решений в активной спецификации функции и записать уточнения непосредственно в файл спецификации.

Примечание: Ожидается, что этот процесс уточнения запустится (и будет завершен) ДО вызова `/speckit.plan`. Если пользователь явно заявляет, что пропускает уточнение (напр., исследовательский спайк), вы можете продолжить, но должны предупредить, что риск доработки вниз по потоку увеличивается.

Шаги выполнения:

1. Запустите `.specify/scripts/bash/check-prerequisites.sh --json --paths-only` из корня репозитория **один раз** (комбинированный режим `--json --paths-only` / `-Json -PathsOnly`). Разберите минимальные поля полезной нагрузки JSON:
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - (Опционально захватите `IMPL_PLAN`, `TASKS` для будущих цепных потоков.)
   - Если парсинг JSON не удается, прервите и проинструктируйте пользователя повторно запустить `/speckit.specify` или проверить окружение ветки функции.
   - Для одинарных кавычек в аргументах вроде "I'm Groot", используйте синтаксис экранирования: напр. 'I'\''m Groot' (или двойные кавычки если возможно: "I'm Groot").

2. Загрузите текущий файл спецификации. Выполните структурированное сканирование неоднозначности и покрытия, используя эту таксономию. Для каждой категории отметьте статус: Ясно / Частично / Отсутствует. Создайте внутреннюю карту покрытия, используемую для приоритизации (не выводите исходную карту, если вопросы не будут задаваться).

   Функциональная Область и Поведение:
   - Основные цели пользователя и критерии успеха
   - Явные декларации вне области
   - Дифференциация пользовательских ролей / персон

   Доменная и Модель Данных:
   - Сущности, атрибуты, отношения
   - Правила идентичности и уникальности
   - Переходы жизненного цикла/состояния
   - Объем данных / предположения масштаба

   Взаимодействие и UX Поток:
   - Критические пользовательские путешествия / последовательности
   - Состояния ошибки/пустоты/загрузки
   - Примечания о доступности или локализации

   Нефункциональные Атрибуты Качества:
   - Производительность (задержка, целевые показатели пропускной способности)
   - Масштабируемость (горизонтальная/вертикальная, ограничения)
   - Надежность и доступность (время безотказной работы, ожидания восстановления)
   - Наблюдаемость (логирование, метрики, сигналы трассировки)
   - Безопасность и конфиденциальность (authN/Z, защита данных, предположения об угрозах)
   - Соответствие / регуляторные ограничения (если есть)

   Интеграция и Внешние Зависимости:
   - Внешние сервисы/API и режимы отказа
   - Форматы импорта/экспорта данных
   - Предположения о протоколе/версионировании

   Крайние Случаи и Обработка Отказов:
   - Негативные сценарии
   - Ограничение скорости / троттлинг
   - Разрешение конфликтов (напр., одновременные правки)

   Ограничения и Компромиссы:
   - Технические ограничения (язык, хранилище, хостинг)
   - Явные компромиссы или отвергнутые альтернативы

   Терминология и Согласованность:
   - Канонические глоссарные термины
   - Избегаемые синонимы / устаревшие термины

   Сигналы Завершенности:
   - Тестируемость критериев приемки
   - Измеримые индикаторы в стиле Definition of Done

   Разное / Заполнители:
   - Маркеры TODO / неразрешенные решения
   - Неоднозначные прилагательные ("надежный", "интуитивный"), лишенные квантификации

   Для каждой категории со статусом Частично или Отсутствует, добавьте возможность кандидата вопроса, если только:
   - Уточнение не изменит существенно стратегию реализации или валидации
   - Информация не лучше отложена до фазы планирования (отметьте внутренне)

3. Сгенерируйте (внутренне) приоритизированную очередь кандидатов уточняющих вопросов (максимум 5). НЕ выводите их все сразу. Применяйте эти ограничения:
   - Максимум 10 вопросов всего за всю сессию.
   - Каждый вопрос должен быть отвечен ЛИБО:
     - Коротким выбором из нескольких вариантов (2–5 различных, взаимоисключающих опций), ИЛИ
     - Ответом из одного слова / короткой фразы (явно ограничьте: "Ответьте ≤5 слов").
   - Включайте только вопросы, ответы на которые существенно влияют на архитектуру, моделирование данных, декомпозицию задач, дизайн тестов, поведение UX, операционную готовность или валидацию соответствия.
   - Обеспечьте баланс покрытия категорий: пытайтесь покрыть категории с наивысшим влиянием неразрешенных в первую очередь; избегайте задавать два вопроса с низким влиянием, когда одна область с высоким влиянием (напр., позиция безопасности) неразрешена.
   - Исключите вопросы, уже отвеченные, тривиальные стилистические предпочтения или детали выполнения на уровне плана (если только не блокирует корректность).
   - Отдайте предпочтение уточнениям, которые уменьшают риск доработки вниз по потоку или предотвращают несогласованные тесты приемки.
   - Если более 5 категорий остаются неразрешенными, выберите топ 5 по эвристике (Влияние \* Неопределенность).

4. Цикл последовательного опроса (интерактивный):
   - Представляйте ТОЧНО ОДИН вопрос за раз.
   - Для вопросов с множественным выбором:
     - **Проанализируйте все опции** и определите **наиболее подходящую опцию** на основе:
       - Лучших практик для типа проекта
       - Общих шаблонов в похожих реализациях
       - Снижения риска (безопасность, производительность, поддерживаемость)
       - Выравнивания с любыми явными целями проекта или ограничениями, видимыми в спецификации
     - Представьте свою **рекомендуемую опцию видно** сверху с четким обоснованием (1-2 предложения, объясняющие, почему это лучший выбор).
     - Форматируйте как: `**Рекомендуется:** Опция [X] - <обоснование>`
     - Затем отобразите все опции как таблицу Markdown:

     | Опция    | Описание                                                                                                  |
     | -------- | --------------------------------------------------------------------------------------------------------- |
     | A        | <Описание опции A>                                                                                        |
     | B        | <Описание опции B>                                                                                        |
     | C        | <Описание опции C> (добавьте D/E по необходимости до 5)                                                   |
     | Короткое | Предоставьте другой короткий ответ (≤5 слов) (Включайте только если уместна альтернатива свободной формы) |
     - После таблицы добавьте: `Вы можете ответить буквой опции (напр., "A"), принять рекомендацию, сказав "да" или "рекомендуется", или предоставить свой короткий ответ.`

   - Для короткого ответа (нет значимых дискретных опций):
     - Предоставьте свой **предлагаемый ответ** на основе лучших практик и контекста.
     - Форматируйте как: `**Предлагается:** <ваш предложенный ответ> - <краткое обоснование>`
     - Затем выведите: `Формат: Короткий ответ (≤5 слов). Вы можете принять предложение, сказав "да" или "предлагается", или предоставить свой ответ.`
   - После того, как пользователь ответит:
     - Если пользователь отвечает "да", "рекомендуется" или "предлагается", используйте вашу ранее заявленную рекомендацию/предложение в качестве ответа.
     - В противном случае, проверьте, что ответ соответствует одной опции или подходит под ограничение ≤5 слов.
     - Если неоднозначно, попросите быстрого уточнения (счет все еще принадлежит тому же вопросу; не продвигайтесь вперед).
     - После удовлетворительного ответа, запишите его в рабочую память (пока не записывайте на диск) и перейдите к следующему вопросу в очереди.
   - Прекратите задавать дальнейшие вопросы, когда:
     - Все критические неоднозначности разрешены рано (оставшиеся вопросы в очереди становятся ненужными), ИЛИ
     - Пользователь сигнализирует о завершении ("готово", "хорошо", "больше нет"), ИЛИ
     - Вы достигли 5 заданных вопросов.
   - Никогда не раскрывайте будущие вопросы в очереди заранее.
   - Если нет действительных вопросов в начале, немедленно сообщите, что критических неоднозначностей нет.

5. Интеграция после КАЖДОГО принятого ответа (инкрементальный подход обновления):
   - Поддерживайте представление спецификации в памяти (загружено один раз в начале) плюс сырое содержимое файла.
   - Для первого интегрированного ответа в этой сессии:
     - Убедитесь, что существует раздел `## Clarifications` (создайте его сразу после самого высокоуровневого контекстуального/обзорного раздела по шаблону спецификации, если отсутствует).
     - Под ним создайте (если не присутствует) подзаголовок `### Session YYYY-MM-DD` для сегодня.
   - Добавьте строку буллета немедленно после принятия: `- Q: <вопрос> → A: <финальный ответ>`.
   - Затем немедленно примените уточнение к наиболее подходящему разделу(ам):
     - Функциональная неоднозначность → Обновите или добавьте буллет в Функциональные Требования.
     - Взаимодействие пользователя / различие актора → Обновите Пользовательские Истории или подраздел Актеров (если присутствует) с уточненной ролью, ограничением или сценарием.
     - Форма данных / сущности → Обновите Модель Данных (добавьте поля, типы, отношения), сохраняя упорядочение; отметьте добавленные ограничения кратко.
     - Нефункциональное ограничение → Добавьте/модифицируйте измеримые критерии в разделе Нефункциональные / Атрибуты Качества (конвертируйте расплывчатое прилагательное в метрику или явную цель).
     - Крайний случай / негативный поток → Добавьте новый буллет под Крайние Случаи / Обработка Ошибок (или создайте такой подраздел, если шаблон предоставляет заполнитель для него).
     - Конфликт терминологии → Нормализуйте термин по всей спецификации; сохраняйте оригинал только если необходимо, добавив `(ранее называлось "X")` один раз.
   - Если уточнение аннулирует более раннее неоднозначное утверждение, замените это утверждение вместо дублирования; не оставляйте устаревший противоречивый текст.
   - Сохраните файл спецификации ПОСЛЕ каждой интеграции, чтобы минимизировать риск потери контекста (атомарная перезапись).
   - Сохраняйте форматирование: не переупорядочивайте не связанные разделы; держите иерархию заголовков неизменной.
   - Держите каждое вставленное уточнение минимальным и тестируемым (избегайте нарративного дрейфа).

6. Валидация (выполняется после КАЖДОЙ записи плюс финальный проход):
   - Сессия уточнений содержит точно один буллет на принятый ответ (без дубликатов).
   - Всего заданных (принятых) вопросов ≤ 5.
   - Обновленные разделы не содержат оставшихся расплывчатых заполнителей, которые новый ответ должен был разрешить.
   - Не остается противоречивого более раннего утверждения (сканируйте на теперь недействительные альтернативные выборы удаленные).
   - Структура Markdown валидна; только разрешенные новые заголовки: `## Clarifications`, `### Session YYYY-MM-DD`.
   - Согласованность терминологии: один канонический термин используется во всех обновленных разделах.

7. Запишите обновленную спецификацию обратно в `FEATURE_SPEC`.

8. Сообщите о завершении (после окончания цикла опроса или раннего завершения):
   - Количество заданных и отвеченных вопросов.
   - Путь к обновленной спецификации.
   - Затронутые разделы (перечислите имена).
   - Таблица сводки покрытия, перечисляющая каждую категорию таксономии со Статусом: Разрешено (было Частично/Отсутствует и адресовано), Отложено (превышает квоту вопросов или лучше подходит для планирования), Ясно (уже достаточно), Неразрешенное (все еще Частично/Отсутствует, но низкое влияние).
   - Если какие-то Неразрешенные или Отложенные остаются, рекомендуйте, стоит ли перейти к `/speckit.plan` или запустить `/speckit.clarify` снова позже после плана.
   - Предлагаемая следующая команда.

Правила поведения:

- Если не найдено значимых неоднозначностей (или все потенциальные вопросы будут с низким влиянием), ответьте: "Критических неоднозначностей, стоящих формального уточнения, не обнаружено." и предложите продолжить.
- Если файл спецификации отсутствует, проинструктируйте пользователя сначала запустить `/speckit.specify` (не создавайте новую спецификацию здесь).
- Никогда не превышайте 5 всего заданных вопросов (повторные попытки уточнения для одного вопроса не считаются новыми вопросами).
- Избегайте спекулятивных вопросов о технологическом стеке, если только отсутствие не блокирует функциональную ясность.
- Уважайте сигналы раннего завершения пользователя ("стоп", "готово", "продолжить").
- Если не задано вопросов из-за полного покрытия, выведите компактную сводку покрытия (все категории Ясно), затем предложите продвигаться.
- Если квота достигнута с оставшимися неразрешенными категориями с высоким влиянием, явно отметьте их под Отложенными с обоснованием.

Контекст для приоритизации: $ARGUMENTS
